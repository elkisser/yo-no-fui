---
import MainLayout from "../layouts/MainLayout.astro";
import {
  Archive,
  FileText,
  Clock,
  CheckCircle,
  Search,
  Download,
  Trash2,
  Filter,
  BarChart3,
  TrendingUp,
  Target,
  AlertCircle,
  ChevronRight,
  Fingerprint,
  Briefcase,
  Users,
  Puzzle,
  Shield,
  Lock,
  X,
  Eye,
} from "lucide-react";
---

<MainLayout>
  <div class="min-h-screen bg-fondo-principal paper-texture">
    {/* Fondo decorativo sutil - Estilo expediente */}
    <div class="absolute inset-0 overflow-hidden pointer-events-none">
      <div
        class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-acento-azul/10 to-transparent"
      >
      </div>
      <div
        class="absolute top-20 -left-20 w-96 h-96 bg-acento-azul/2 rounded-full blur-3xl opacity-30"
      >
      </div>
      <div
        class="absolute bottom-20 -right-20 w-96 h-96 bg-acento-turquesa/2 rounded-full blur-3xl opacity-30"
      >
      </div>

      {/* Huellas digitales sutiles */}
      <div class="absolute top-1/4 left-10 w-24 h-36 opacity-5">
        <div
          class="w-8 h-12 rounded-full border border-acento-azul transform rotate-12"
        >
        </div>
      </div>
      <div class="absolute bottom-1/4 right-10 w-24 h-36 opacity-5">
        <div
          class="w-8 h-12 rounded-full border border-acento-turquesa transform -rotate-12"
        >
        </div>
      </div>
    </div>

    <div class="relative z-10 max-w-7xl mx-auto px-4 py-12">
      {/* Header elegante - Estilo expediente */}
      <div class="mb-12">
        <div class="flex items-center gap-6 mb-8">
          <div class="relative">
            {/* Expediente principal */}
            <div
              class="relative w-16 h-16 rounded-xl bg-gradient-to-br from-fondo-panel to-fondo-secundario border-2 border-fondo-borde/60 flex items-center justify-center shadow-xl"
            >
              {/* Clip de carpeta */}
              <div
                class="absolute -top-3 left-1/2 transform -translate-x-1/2 w-10 h-4 bg-gradient-to-b from-gray-600 to-gray-800 rounded-t-lg"
              >
              </div>

              {/* Contenido del expediente */}
              <Archive class="w-8 h-8 text-acento-azul" />

              {/* Tachuelas */}
              <div
                class="absolute -top-1 -left-1 w-3 h-3 rounded-full bg-gradient-to-br from-yellow-600 to-yellow-800"
              >
              </div>
              <div
                class="absolute -top-1 -right-1 w-3 h-3 rounded-full bg-gradient-to-br from-yellow-600 to-yellow-800"
              >
              </div>
            </div>

            {/* Sello oficial */}
            <div
              class="absolute -bottom-2 -right-2 w-8 h-8 rounded-full bg-gradient-to-br from-red-500 to-red-700 flex items-center justify-center border-2 border-fondo-principal"
            >
              <div class="w-2 h-2 rounded-full bg-white"></div>
            </div>
          </div>

          <div class="flex-1">
            <div class="flex items-center gap-3 mb-2">
              <div class="w-4 h-0.5 bg-acento-azul"></div>
              <span
                class="text-sm font-mono text-acento-azul/80 tracking-widest uppercase"
              >
                ARCHIVO CRIMINAL
              </span>
              <div class="w-4 h-0.5 bg-acento-azul"></div>
            </div>

            <h1
              class="text-4xl md:text-5xl font-serif font-bold text-texto-principal mb-3"
            >
              Casos Archivados
            </h1>
            <p class="text-texto-secundario text-lg">
              Historial completo de investigaciones resueltas
            </p>
          </div>
        </div>

        {/* Barra de b√∫squeda y filtros - Estilo interfaz policial */}
        <div class="flex flex-col md:flex-row gap-4 mb-8">
          <div class="flex-1 relative group">
            <div
              class="absolute inset-0 bg-gradient-to-r from-acento-azul/5 to-acento-turquesa/5 rounded-xl blur opacity-0 group-hover:opacity-100 transition-opacity duration-300"
            >
            </div>

            <div class="relative h-12">
              <input
                type="text"
                id="buscar-casos"
                placeholder="üîé Buscar casos por t√≠tulo, ID o fecha..."
                class="h-12 w-full pl-11 pr-4 bg-fondo-panel/30 backdrop-blur-sm border-2 border-fondo-borde/50 rounded-xl text-texto-principal placeholder:text-texto-secundario/50 focus:outline-none focus:border-acento-azul focus:ring-2 focus:ring-acento-azul/20 transition-all duration-300"
              />
            </div>
          </div>

          <div class="flex gap-3">
            <button
              onclick="filtrarCasos('todos')"
              class="h-12 px-5 bg-fondo-panel/30 backdrop-blur-sm border-2 border-fondo-borde/50 rounded-xl text-texto-principal hover:border-acento-azul hover:bg-acento-azul/5 transition-all duration-300 flex items-center gap-2 group action-btn"
            >
              <Filter
                class="w-4 h-4 text-texto-secundario group-hover:text-acento-azul transition-colors"
              />
              <span class="text-sm font-medium">Todos</span>
            </button>

            <button
              onclick="filtrarCasos('resueltos')"
              class="h-12 px-5 bg-fondo-panel/30 backdrop-blur-sm border-2 border-fondo-borde/50 rounded-xl text-texto-principal hover:border-green-500 hover:bg-green-500/5 transition-all duration-300 flex items-center gap-2 group action-btn"
            >
              <CheckCircle
                class="w-4 h-4 text-texto-secundario group-hover:text-green-400 transition-colors"
              />
              <span class="text-sm font-medium">Resueltos</span>
            </button>

            <button
              onclick="filtrarCasos('pendientes')"
              class="h-12 px-5 bg-fondo-panel/30 backdrop-blur-sm border-2 border-fondo-borde/50 rounded-xl text-texto-principal hover:border-yellow-500 hover:bg-yellow-500/5 transition-all duration-300 flex items-center gap-2 group action-btn"
            >
              <Clock
                class="w-4 h-4 text-texto-secundario group-hover:text-yellow-400 transition-colors"
              />
              <span class="text-sm font-medium">Pendientes</span>
            </button>
          </div>
        </div>
      </div>

      {/* Contenido principal */}
      <div class="grid lg:grid-cols-3 gap-8">
        {/* Panel izquierdo - Lista de casos */}
        <div class="lg:col-span-2">
          <div
            class="bg-fondo-panel/20 backdrop-blur-sm border-2 border-fondo-borde/50 rounded-2xl overflow-hidden detective-desk"
          >
            {/* Header de la lista */}
            <div
              class="p-6 border-b border-fondo-borde/30 bg-gradient-to-r from-fondo-panel/30 to-transparent"
            >
              <div class="flex items-center justify-between">
                <div>
                  <div class="flex items-center gap-3 mb-2">
                    <div
                      class="w-3 h-3 rounded-full bg-acento-azul animate-pulse"
                    >
                    </div>
                    <h2 class="text-2xl font-serif text-texto-principal">
                      Expedientes
                    </h2>
                  </div>
                  <p class="text-sm text-texto-secundario">
                    <span
                      id="contador-casos"
                      class="font-bold text-texto-principal">0</span
                    > casos encontrados
                  </p>
                </div>

                <div class="flex items-center gap-3">
                  <div class="text-sm text-texto-secundario hidden md:block">
                    Ordenar por:
                  </div>
                  <select
                    id="ordenar-casos"
                    class="px-4 py-2.5 bg-fondo-secundario/30 backdrop-blur-sm border-2 border-fondo-borde/50 rounded-lg text-texto-principal text-sm focus:outline-none focus:border-acento-azul focus:ring-2 focus:ring-acento-azul/20 transition-all duration-300"
                  >
                    <option value="reciente">M√°s reciente</option>
                    <option value="antiguo">M√°s antiguo</option>
                    <option value="titulo">T√≠tulo (A-Z)</option>
                    <option value="estado">Estado</option>
                  </select>
                </div>
              </div>
            </div>

            {/* Lista de casos */}
            <div class="divide-y divide-fondo-borde/30">
              <div id="casos-lista" class="min-h-[400px]">
                <!-- Los casos se cargar√°n aqu√≠ -->
              </div>

              <!-- Estado vac√≠o -->
              <div id="sin-casos" class="hidden p-12 text-center">
                <div class="max-w-sm mx-auto">
                  <div
                    class="w-24 h-24 mx-auto mb-6 rounded-2xl bg-gradient-to-br from-fondo-borde/20 to-fondo-borde/10 flex items-center justify-center"
                  >
                    <Archive class="w-12 h-12 text-texto-secundario/30" />
                  </div>

                  <h3 class="text-xl font-serif text-texto-principal mb-3">
                    Archivo vac√≠o
                  </h3>

                  <p class="text-texto-secundario mb-8">
                    A√∫n no has resuelto ning√∫n caso. ¬°Comienza una investigaci√≥n
                    para llenar este archivo!
                  </p>

                  <a
                    href="/nuevo-caso"
                    class="inline-flex items-center gap-3 px-8 py-4 bg-gradient-to-r from-acento-azul to-acento-turquesa text-fondo-principal font-bold rounded-xl hover:opacity-90 transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-acento-azul/30 action-btn"
                  >
                    <FileText class="w-5 h-5" />
                    <span>Nuevo caso</span>
                    <ChevronRight class="w-5 h-5" />
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* Panel derecho - Estad√≠sticas y acciones */}
        <div class="space-y-8">
          {/* Tarjeta de estad√≠sticas */}
          <div
            class="bg-fondo-panel/20 backdrop-blur-sm border-2 border-fondo-borde/50 rounded-2xl p-6 detective-desk"
          >
            <div class="flex items-center gap-3 mb-6">
              <div
                class="w-12 h-12 rounded-xl bg-gradient-to-br from-acento-azul/20 to-acento-turquesa/20 border border-acento-azul/30 flex items-center justify-center"
              >
                <BarChart3 class="w-6 h-6 text-acento-azul" />
              </div>
              <h3 class="text-xl font-serif text-texto-principal">
                Estad√≠sticas
              </h3>
            </div>

            <div class="space-y-5">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <Fingerprint class="w-5 h-5 text-texto-secundario" />
                  <span class="text-texto-secundario">Casos totales</span>
                </div>
                <span
                  class="text-2xl font-bold text-texto-principal"
                  id="total-casos">0</span
                >
              </div>

              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <CheckCircle class="w-5 h-5 text-green-400" />
                  <span class="text-texto-secundario">Resueltos</span>
                </div>
                <span
                  class="text-2xl font-bold text-green-400"
                  id="casos-resueltos">0</span
                >
              </div>

              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <Clock class="w-5 h-5 text-yellow-400" />
                  <span class="text-texto-secundario">Pendientes</span>
                </div>
                <span
                  class="text-2xl font-bold text-yellow-400"
                  id="casos-pendientes">0</span
                >
              </div>

              <div class="pt-4 border-t border-fondo-borde/30">
                <div class="flex items-center justify-between mb-2">
                  <div class="flex items-center gap-3">
                    <TrendingUp class="w-5 h-5 text-acento-turquesa" />
                    <span class="text-texto-secundario">Tasa de √©xito</span>
                  </div>
                  <span
                    class="text-2xl font-bold text-acento-turquesa"
                    id="tasa-exito">0%</span
                  >
                </div>
                <div
                  class="w-full h-2 bg-fondo-borde/50 rounded-full overflow-hidden"
                >
                  <div
                    id="barra-exito"
                    class="h-full bg-gradient-to-r from-acento-azul to-acento-turquesa rounded-full transition-all duration-1000"
                    style="width: 0%"
                  >
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* Tarjeta de caso activo */}
          <div
            id="tarjeta-activo"
            class="hidden bg-gradient-to-br from-acento-azul/10 to-acento-turquesa/10 border-2 border-acento-azul/30 rounded-2xl p-6 detective-desk"
          >
            <div class="flex items-center gap-3 mb-4">
              <div
                class="w-10 h-10 rounded-lg bg-acento-azul/20 border border-acento-azul/30 flex items-center justify-center"
              >
                <Target class="w-5 h-5 text-acento-azul" />
              </div>
              <h3 class="text-lg font-serif text-texto-principal">
                Caso activo
              </h3>
              <div
                class="ml-auto w-3 h-3 rounded-full bg-green-400 animate-pulse"
              >
              </div>
            </div>

            <div class="mb-4">
              <h4
                id="titulo-activo"
                class="text-texto-principal font-medium mb-1 truncate"
              >
              </h4>
              <p class="text-sm text-texto-secundario">
                <span id="tiempo-activo"></span> de investigaci√≥n
              </p>
            </div>

            <a
              href="/investigar"
              class="block w-full py-3 bg-gradient-to-r from-acento-azul to-acento-turquesa text-fondo-principal text-center font-bold rounded-lg hover:opacity-90 transition-opacity shadow-lg hover:shadow-acento-azul/30 action-btn"
            >
              Continuar investigaci√≥n
            </a>
          </div>

          {/* Tarjeta de acciones */}
          <div
            class="bg-fondo-panel/20 backdrop-blur-sm border-2 border-fondo-borde/50 rounded-2xl p-6 detective-desk"
          >
            <div class="flex items-center gap-3 mb-6">
              <Briefcase class="w-6 h-6 text-acento-azul" />
              <h3 class="text-lg font-serif text-texto-principal">
                Gesti√≥n del archivo
              </h3>
            </div>

            <div class="space-y-4">
              <button
                onclick="exportarHistorial()"
                class="w-full py-3.5 bg-fondo-secundario/30 backdrop-blur-sm border-2 border-fondo-borde/50 rounded-xl text-texto-principal hover:border-acento-azul hover:bg-acento-azul/5 transition-all duration-300 flex items-center justify-center gap-3 group action-btn"
              >
                <Download
                  class="w-5 h-5 text-texto-secundario group-hover:text-acento-azul transition-colors"
                />
                <span class="font-bold">Exportar historial</span>
              </button>

              <button
                onclick="limpiarHistorial()"
                class="w-full py-3.5 bg-red-500/10 backdrop-blur-sm border-2 border-red-500/20 rounded-xl text-red-400 hover:bg-red-500/20 hover:border-red-500/40 transition-all duration-300 flex items-center justify-center gap-3 group action-btn"
              >
                <Trash2
                  class="w-5 h-5 group-hover:scale-110 transition-transform"
                />
                <span class="font-bold">Limpiar archivo</span>
              </button>
            </div>

            <div class="mt-6 pt-6 border-t border-fondo-borde/30">
              <div class="flex items-start gap-3">
                <AlertCircle
                  class="w-5 h-5 text-texto-secundario/60 flex-shrink-0 mt-0.5"
                />
                <p class="text-xs text-texto-secundario/60 leading-relaxed">
                  El archivo se almacena localmente en tu navegador. Para
                  respaldo permanente, exporta regularmente tu historial.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Confirmaci√≥n -->
  <div
    id="modal-confirmacion"
    class="fixed inset-0 z-50 hidden transition-all duration-300 opacity-0 pointer-events-none"
  >
    <div
      class="absolute inset-0 bg-black/60 backdrop-blur-sm"
      onclick="cerrarModal()"
    >
    </div>
    <div
      class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-md p-6 bg-fondo-panel border-2 border-fondo-borde rounded-2xl shadow-2xl scale-95 transition-all duration-300 detective-desk"
      id="modal-content"
    >
      <div class="flex items-center gap-3 mb-4" id="modal-header">
        <!-- Icono din√°mico -->
      </div>

      <h3
        id="modal-titulo"
        class="text-xl font-serif text-texto-principal mb-2"
      >
      </h3>
      <p id="modal-mensaje" class="text-texto-secundario mb-8 leading-relaxed">
      </p>

      <div class="flex justify-end gap-3">
        <button
          onclick="cerrarModal()"
          class="px-5 py-2.5 rounded-xl border-2 border-fondo-borde text-texto-secundario hover:text-texto-principal hover:bg-fondo-secundario/30 transition-all duration-200 font-medium action-btn"
        >
          Cancelar
        </button>
        <button
          id="modal-accion-btn"
          class="px-5 py-2.5 rounded-xl text-fondo-principal font-bold shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105 action-btn"
        >
          Confirmar
        </button>
      </div>
    </div>
  </div>

  <style>
    /* Animaciones */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-fade-in-up {
      animation: fadeInUp 0.5s ease-out forwards;
    }

    /* Clases para el modal activo */
    #modal-confirmacion.activo {
      opacity: 1;
      pointer-events: auto;
    }

    #modal-confirmacion.activo #modal-content {
      transform: translate(-50%, -50%) scale(100%);
    }

    /* Efectos hover para tarjetas */
    .caso-card {
      transition: all 0.3s ease;
      position: relative;
    }

    .caso-card:hover {
      background: linear-gradient(
        90deg,
        rgba(77, 163, 255, 0.05) 0%,
        rgba(94, 234, 212, 0.02) 100%
      );
      border-color: rgba(77, 163, 255, 0.3);
      transform: translateX(4px);
    }

    .caso-card::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: linear-gradient(
        to bottom,
        transparent,
        var(--tw-gradient-stops),
        transparent
      );
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .caso-card:hover::before {
      opacity: 1;
      background: linear-gradient(to bottom, transparent, #4da3ff, transparent);
    }

    .action-btn.active {
      border-color: var(--acento-azul);
      background-color: rgba(0, 153, 255, 0.08);
    }
  </style>

  <script>
    // Variables globales
    let historialOriginal = [];
    let historialFiltrado = [];
    let filtroActual = "todos";
    let accionPendiente = null;

    // Cargar historial de casos
    function cargarHistorial() {
      try {
        historialOriginal = JSON.parse(
          localStorage.getItem("historial-casos") || "[]"
        );
        aplicarFiltro();
        mostrarCasoActivo();
      } catch (error) {
        console.error("Error cargando historial:", error);
        historialOriginal = [];
        mostrarSinCasos();
      }
    }

    // Aplicar filtro actual
    function aplicarFiltro() {
      const contador = document.getElementById("contador-casos");

      switch (filtroActual) {
        case "resueltos":
          historialFiltrado = historialOriginal.filter((c) => c.resuelto);
          break;
        case "pendientes":
          historialFiltrado = historialOriginal.filter((c) => !c.resuelto);
          break;
        case "todos":
        default:
          historialFiltrado = [...historialOriginal];
      }

      // Aplicar b√∫squeda si existe
      const busquedaInput = document.getElementById("buscar-casos");
      if (busquedaInput && busquedaInput.value) {
        const term = busquedaInput.value.toLowerCase();
        historialFiltrado = historialFiltrado.filter(
          (caso) =>
            (caso.titulo && caso.titulo.toLowerCase().includes(term)) ||
            (caso.casoId && caso.casoId.toLowerCase().includes(term)) ||
            (caso.fecha && caso.fecha.toLowerCase().includes(term))
        );
      }

      // Aplicar orden
      const ordenInput = document.getElementById("ordenar-casos");
      if (ordenInput) {
        ordenarCasos(ordenInput.value);
      }

      if (contador) contador.textContent = historialFiltrado.length;
      actualizarEstadisticas();

      if (historialFiltrado.length === 0) {
        mostrarSinCasos();
      } else {
        mostrarCasos();
      }
    }

    // Ordenar casos
    function ordenarCasos(orden) {
      historialFiltrado.sort((a, b) => {
        switch (orden) {
          case "antiguo":
            return (
              new Date(a.fechaCreacion || a.fecha) -
              new Date(b.fechaCreacion || b.fecha)
            );
          case "titulo":
            return (a.titulo || "").localeCompare(b.titulo || "");
          case "estado":
            return (b.resuelto ? 1 : 0) - (a.resuelto ? 1 : 0);
          case "reciente":
          default:
            return (
              new Date(b.fechaCreacion || b.fecha) -
              new Date(a.fechaCreacion || a.fecha)
            );
        }
      });
    }

    // Mostrar lista de casos
    function mostrarCasos() {
      const casosLista = document.getElementById("casos-lista");
      const sinCasos = document.getElementById("sin-casos");

      if (sinCasos) sinCasos.classList.add("hidden");
      if (casosLista) {
        casosLista.classList.remove("hidden");
        casosLista.innerHTML = historialFiltrado
          .map((caso, index) => {
            // Formatear fecha correctamente
            let fechaFormateada = "Fecha desconocida";
            let tiempo = "";

            if (caso.fechaCreacion) {
              const fecha = new Date(caso.fechaCreacion);
              fechaFormateada = fecha.toLocaleDateString("es-ES", {
                day: "numeric",
                month: "short",
                year: "numeric",
              });
              tiempo = fecha.toLocaleTimeString("es-ES", {
                hour: "2-digit",
                minute: "2-digit",
              });
            } else if (caso.fecha) {
              fechaFormateada = caso.fecha;
            }

            // Mostrar ID m√°s corto para mejor visualizaci√≥n
            const casoIdCorto = caso.casoId
              ? `${caso.casoId.substring(0, 8)}...`
              : "Sin ID";

            return `
            <div class="caso-card p-5 border-b border-fondo-borde/30 last:border-b-0 animate-fade-in-up group/card" 
                 style="animation-delay: ${index * 0.05}s">
              <div class="flex items-start justify-between">
                <div class="flex-1 min-w-0 pr-4">
                  <div class="flex items-center gap-3 mb-3">
                    <div class="flex items-center gap-2">
                      <div class="w-2 h-2 rounded-full ${caso.resuelto ? "bg-green-400" : "bg-yellow-400"} animate-pulse"></div>
                      <span class="text-xs font-bold px-3 py-1 rounded-full ${caso.resuelto ? "bg-green-400/10 text-green-400 border border-green-400/30" : "bg-yellow-400/10 text-yellow-400 border border-yellow-400/30"}">
                        ${caso.resuelto ? "RESUELTO" : "PENDIENTE"}
                      </span>
                    </div>
                    
                    <span class="text-xs text-texto-secundario/70 font-mono">
                      ${fechaFormateada} ${tiempo ? `‚Ä¢ ${tiempo}` : ""}
                    </span>
                  </div>
                  
                  <h3 class="text-lg font-bold text-texto-principal mb-2 truncate group-hover/card:text-acento-azul transition-colors">
                    ${caso.titulo || "Caso sin t√≠tulo"}
                  </h3>
                  
                  <div class="flex items-center gap-4 text-sm text-texto-secundario">
                    <div class="flex items-center gap-1.5 min-w-0">
                      <Fingerprint class="w-4 h-4" />
                      <span class="truncate font-mono">ID: ${casoIdCorto}</span>
                    </div>
                    
                    ${
                      caso.tiempoResolucion
                        ? `
                      <div class="flex items-center gap-1.5 whitespace-nowrap">
                        <Clock class="w-4 h-4" />
                        <span>${caso.tiempoResolucion}</span>
                      </div>
                    `
                        : ""
                    }
                    
                    ${
                      caso.dificultad
                        ? `
                      <div class="flex items-center gap-1.5">
                        <Shield class="w-4 h-4" />
                        <span>${caso.dificultad}</span>
                      </div>
                    `
                        : ""
                    }
                  </div>
                  
                  ${
                    caso.descripcion
                      ? `
                    <p class="mt-3 text-sm text-texto-secundario/80 line-clamp-2">
                      ${caso.descripcion}
                    </p>
                  `
                      : ""
                  }
                </div>
                
                <div class="flex flex-col items-center gap-2 ml-4">
                  <button 
                    onclick="verCasoDetalles('${caso.casoId}')"
                    class="p-2 text-texto-secundario hover:text-acento-azul hover:bg-acento-azul/10 rounded-lg transition-all duration-300 opacity-0 group-hover/card:opacity-100 focus:opacity-100 flex items-center gap-1"
                    title="Ver detalles"
                  >
                    <Eye class="w-4 h-4" />
                  </button>
                  
                  <button 
                    onclick="confirmarEliminarCaso('${caso.casoId}', '${caso.titulo || "este caso"}')"
                    class="p-2 text-texto-secundario hover:text-red-400 hover:bg-red-500/10 rounded-lg transition-all duration-300 opacity-0 group-hover/card:opacity-100 focus:opacity-100"
                    title="Eliminar caso"
                  >
                    <X class="w-4 h-4" />
                  </button>
                </div>
              </div>
            </div>
          `;
          })
          .join("");
      }
    }

    // Mostrar estado vac√≠o
    function mostrarSinCasos() {
      const casosLista = document.getElementById("casos-lista");
      const sinCasos = document.getElementById("sin-casos");

      if (casosLista) casosLista.classList.add("hidden");
      if (sinCasos) sinCasos.classList.remove("hidden");
    }

    // Actualizar estad√≠sticas
    function actualizarEstadisticas() {
      const total = historialOriginal.length;
      const resueltos = historialOriginal.filter((c) => c.resuelto).length;
      const pendientes = total - resueltos;
      const tasa = total > 0 ? Math.round((resueltos / total) * 100) : 0;

      // Actualizar n√∫meros
      const els = {
        total: document.getElementById("total-casos"),
        resueltos: document.getElementById("casos-resueltos"),
        pendientes: document.getElementById("casos-pendientes"),
        tasa: document.getElementById("tasa-exito"),
        barra: document.getElementById("barra-exito"),
      };

      if (els.total) els.total.textContent = total;
      if (els.resueltos) els.resueltos.textContent = resueltos;
      if (els.pendientes) els.pendientes.textContent = pendientes;
      if (els.tasa) els.tasa.textContent = `${tasa}%`;

      // Animar barra de progreso
      if (els.barra) {
        els.barra.style.width = "0%";
        setTimeout(() => {
          els.barra.style.width = `${tasa}%`;
        }, 100);
      }
    }

    // Mostrar caso activo si existe
    function mostrarCasoActivo() {
      const tarjeta = document.getElementById("tarjeta-activo");
      const storeData = localStorage.getItem("yo-no-fui-storage");

      if (tarjeta && storeData) {
        try {
          const parsedStore = JSON.parse(storeData);
          const caso = parsedStore.state?.casoActual;

          // Verificar que sea un caso activo real (no resuelto)
          const casoEnHistorial = historialOriginal.find(
            (c) => c.casoId === caso?.id
          );
          const estaResuelto = casoEnHistorial?.resuelto || caso?.resuelto;

          if (caso && caso.titulo && caso.id && !estaResuelto) {
            const tiempoInicio = parsedStore.state.tiempoInicio
              ? new Date(parsedStore.state.tiempoInicio)
              : new Date();
            const ahora = new Date();
            const diffMs = ahora - tiempoInicio;
            const diffMinutos = Math.floor(diffMs / (1000 * 60));
            const diffHoras = Math.floor(diffMinutos / 60);
            const minutosRestantes = diffMinutos % 60;

            const tituloEl = document.getElementById("titulo-activo");
            const tiempoEl = document.getElementById("tiempo-activo");

            if (tituloEl) tituloEl.textContent = caso.titulo;
            if (tiempoEl) {
              tiempoEl.textContent =
                diffHoras > 0
                  ? `${diffHoras}h ${minutosRestantes}m`
                  : `${minutosRestantes}m`;
            }

            tarjeta.classList.remove("hidden");
          } else {
            tarjeta.classList.add("hidden");
          }
        } catch (error) {
          console.error("Error parsing game store:", error);
          tarjeta.classList.add("hidden");
        }
      } else if (tarjeta) {
        tarjeta.classList.add("hidden");
      }
    }

    // L√≥gica del MODAL
    function abrirModal(tipo, titulo, mensaje, accion) {
      const modal = document.getElementById("modal-confirmacion");
      const modalTitulo = document.getElementById("modal-titulo");
      const modalMensaje = document.getElementById("modal-mensaje");
      const modalBtn = document.getElementById("modal-accion-btn");
      const modalHeader = document.getElementById("modal-header");

      if (!modal) return;

      modalTitulo.textContent = titulo;
      modalMensaje.textContent = mensaje;

      // Resetear clases del bot√≥n
      modalBtn.className =
        "px-5 py-2.5 rounded-xl font-bold shadow-lg transition-all duration-200 transform hover:scale-105 action-btn";

      // Remove old event listeners by cloning
      const newBtn = modalBtn.cloneNode(true);
      modalBtn.parentNode.replaceChild(newBtn, modalBtn);

      // Add new listener
      if (accion) {
        newBtn.onclick = () => {
          accion();
          cerrarModal();
        };
      } else {
        newBtn.onclick = cerrarModal;
      }

      if (tipo === "peligro") {
        newBtn.classList.add(
          "bg-gradient-to-r",
          "from-red-500",
          "to-red-600",
          "text-white",
          "hover:shadow-red-500/30"
        );
        newBtn.textContent = "Eliminar";
        modalHeader.innerHTML = `<div class="w-10 h-10 rounded-full bg-red-500/20 flex items-center justify-center text-red-500 border-2 border-red-500/30">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
        </div>`;
      } else if (tipo === "info") {
        newBtn.classList.add(
          "bg-gradient-to-r",
          "from-acento-azul",
          "to-acento-turquesa",
          "text-fondo-principal",
          "hover:shadow-acento-azul/30"
        );
        newBtn.textContent = "Continuar";
        modalHeader.innerHTML = `<div class="w-10 h-10 rounded-full bg-acento-azul/20 flex items-center justify-center text-acento-azul border-2 border-acento-azul/30">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        </div>`;
      } else {
        newBtn.classList.add(
          "bg-gradient-to-r",
          "from-acento-azul",
          "to-acento-turquesa",
          "text-fondo-principal",
          "hover:shadow-acento-azul/30"
        );
        newBtn.textContent = "Aceptar";
        modalHeader.innerHTML = `<div class="w-10 h-10 rounded-full bg-acento-azul/20 flex items-center justify-center text-acento-azul border-2 border-acento-azul/30">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
        </div>`;
      }

      modal.classList.remove("hidden");
      setTimeout(() => modal.classList.add("activo"), 10);
    }

    function cerrarModal() {
      const modal = document.getElementById("modal-confirmacion");
      if (!modal) return;

      modal.classList.remove("activo");
      setTimeout(() => modal.classList.add("hidden"), 300);
    }

    // Funciones de filtro
    function filtrarCasos(tipo) {
      filtroActual = tipo;
      aplicarFiltro();

      // Remover clase activa de todos los botones
      document
        .querySelectorAll('button[onclick^="filtrarCasos"]')
        .forEach((btn) => {
          btn.classList.remove(
            "bg-acento-azul/10",
            "border-acento-azul",
            "bg-green-500/10",
            "border-green-500",
            "bg-yellow-500/10",
            "border-yellow-500"
          );
        });

      // Agregar clase activa al bot√≥n seleccionado
      const botonActual = document.querySelector(
        `button[onclick="filtrarCasos('${tipo}')"]`
      );
      if (botonActual) {
        if (tipo === "todos") {
          botonActual.classList.add("bg-acento-azul/10", "border-acento-azul");
        } else if (tipo === "resueltos") {
          botonActual.classList.add("bg-green-500/10", "border-green-500");
        } else if (tipo === "pendientes") {
          botonActual.classList.add("bg-yellow-500/10", "border-yellow-500");
        }
      }
    }

    // ELIMINAR CASO INDIVIDUAL - CORREGIDO
    function confirmarEliminarCaso(casoId, tituloCaso) {
      abrirModal(
        "peligro",
        "Eliminar Expediente",
        `¬øEst√°s seguro de que quieres eliminar el caso "${tituloCaso}" permanentemente? Esta acci√≥n no se puede deshacer.`,
        () => eliminarCasoIndividual(casoId)
      );
    }

    function eliminarCasoIndividual(casoId) {
      // Encontrar el √≠ndice del caso espec√≠fico (usando el primer caso con ese ID)
      const casoIndex = historialOriginal.findIndex((c) => c.casoId === casoId);

      if (casoIndex !== -1) {
        // Eliminar solo ese caso del array
        historialOriginal.splice(casoIndex, 1);

        // Actualizar localStorage
        localStorage.setItem(
          "historial-casos",
          JSON.stringify(historialOriginal)
        );

        // Recargar la vista
        aplicarFiltro();

        // Mostrar confirmaci√≥n
        setTimeout(() => {
          abrirModal(
            "info",
            "Caso Eliminado",
            "El caso ha sido eliminado exitosamente del archivo.",
            null
          );
        }, 300);
      } else {
        abrirModal(
          "info",
          "Caso No Encontrado",
          "No se pudo encontrar el caso especificado. Puede que ya haya sido eliminado.",
          null
        );
      }
    }

    // Ver detalles del caso
    function verCasoDetalles(casoId) {
      const caso = historialOriginal.find((c) => c.casoId === casoId);

      if (!caso) {
        abrirModal(
          "info",
          "Caso No Encontrado",
          "No se pudo encontrar la informaci√≥n del caso.",
          null
        );
        return;
      }

      let detalles = `T√≠tulo: ${caso.titulo || "Sin t√≠tulo"}\n`;
      detalles += `Estado: ${caso.resuelto ? "‚úÖ Resuelto" : "‚è≥ Pendiente"}\n`;
      detalles += `ID: ${caso.casoId || "Sin ID"}\n`;

      if (caso.fechaCreacion) {
        const fecha = new Date(caso.fechaCreacion);
        detalles += `Fecha: ${fecha.toLocaleDateString("es-ES")}\n`;
      }

      if (caso.tiempoResolucion) {
        detalles += `Tiempo de resoluci√≥n: ${caso.tiempoResolucion}\n`;
      }

      if (caso.dificultad) {
        detalles += `Dificultad: ${caso.dificultad}\n`;
      }

      if (caso.descripcion) {
        detalles += `\nDescripci√≥n:\n${caso.descripcion}\n`;
      }

      if (caso.culpable) {
        detalles += `\nCulpable: ${caso.culpable}\n`;
      }

      abrirModal("info", "Detalles del Caso", detalles, null);
    }

    // Cargar caso para continuar investigaci√≥n (SOLO casos pendientes)
    function cargarCasoEnJuego(caso) {
      try {
        // Verificar que el caso no est√© resuelto
        if (caso.resuelto) {
          abrirModal(
            "info",
            "Caso Ya Resuelto",
            "Este caso ya ha sido resuelto y no puede ser reabierto. ¬°Excelente trabajo detective!",
            null
          );
          return;
        }

        const currentStore = JSON.parse(
          localStorage.getItem("yo-no-fui-storage") ||
            '{"state":{},"version":0}'
        );

        const newState = {
          ...currentStore,
          state: {
            ...currentStore.state,
            casoActual: {
              id: caso.casoId,
              titulo: caso.titulo,
              ...caso.data,
              resuelto: false,
            },
            pistasDescubiertas: caso.pistasDescubiertas || [],
            ayudasUsadas: caso.ayudasUsadas || [],
            hipotesisActual: caso.hipotesisActual || null,
            errores: caso.errores || 0,
            tiempoInicio: caso.tiempoInicio || Date.now(),
          },
        };

        localStorage.setItem("yo-no-fui-storage", JSON.stringify(newState));
        window.location.href = "/investigar";
      } catch (e) {
        console.error("Error al cargar el caso:", e);
        abrirModal(
          "info",
          "Error Cr√≠tico",
          "No se pudo cargar el expediente. Int√©ntalo de nuevo.",
          null
        );
      }
    }

    // Exportar historial
    function exportarHistorial() {
      if (historialOriginal.length === 0) {
        abrirModal(
          "info",
          "Archivo Vac√≠o",
          "No hay casos para exportar.",
          null
        );
        return;
      }

      const datos = {
        historial: historialOriginal,
        exportadoEn: new Date().toISOString(),
        totalCasos: historialOriginal.length,
        casosResueltos: historialOriginal.filter((c) => c.resuelto).length,
        version: "Yo no fui - Expediente Criminal v1.0",
        notas: "Archivo de casos generados por IA - Confidencial",
      };

      const dataStr = JSON.stringify(datos, null, 2);
      const dataUri =
        "data:application/json;charset=utf-8," + encodeURIComponent(dataStr);

      const nombreArchivo = `expedientes-criminales-${new Date().toISOString().split("T")[0]}.json`;

      const link = document.createElement("a");
      link.setAttribute("href", dataUri);
      link.setAttribute("download", nombreArchivo);
      link.style.display = "none";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      abrirModal(
        "info",
        "Exportaci√≥n Exitosa",
        `Se han exportado ${historialOriginal.length} casos exitosamente.`,
        null
      );
    }

    // Limpiar historial COMPLETO
    function limpiarHistorial() {
      if (historialOriginal.length === 0) {
        abrirModal(
          "info",
          "Archivo Vac√≠o",
          "No tienes casos archivados para eliminar.",
          null
        );
        return;
      }

      abrirModal(
        "peligro",
        "‚ö†Ô∏è ALERTA: Eliminar TODO el historial",
        `Esta acci√≥n eliminar√° permanentemente los ${historialOriginal.length} casos de tu archivo. Esta acci√≥n NO se puede deshacer. ¬øEst√°s absolutamente seguro?`,
        () => {
          localStorage.removeItem("historial-casos");
          historialOriginal = [];
          aplicarFiltro();

          abrirModal(
            "info",
            "Archivo Limpiado",
            "Todos los casos han sido eliminados del archivo.",
            null
          );
        }
      );
    }

    // Inicializar al cargar la p√°gina
    document.addEventListener("DOMContentLoaded", () => {
      cargarHistorial();

      // Configurar eventos
      const buscarInput = document.getElementById("buscar-casos");
      if (buscarInput) {
        buscarInput.addEventListener("input", () => {
          setTimeout(aplicarFiltro, 300);
        });
      }

      const ordenarSelect = document.getElementById("ordenar-casos");
      if (ordenarSelect) {
        ordenarSelect.addEventListener("change", aplicarFiltro);
      }

      // Aplicar filtro inicial
      filtrarCasos("todos");

      // Efecto de escritura en el t√≠tulo
      const title = document.querySelector("h1");
      if (title) {
        const text = title.textContent;
        title.textContent = "";

        let i = 0;
        const typeWriter = () => {
          if (i < text.length) {
            title.textContent += text.charAt(i);
            i++;
            setTimeout(typeWriter, 50);
          }
        };

        setTimeout(typeWriter, 500);
      }
    });

    // Hacer funciones disponibles globalmente
    window.filtrarCasos = filtrarCasos;
    window.exportarHistorial = exportarHistorial;
    window.limpiarHistorial = limpiarHistorial;
    window.confirmarEliminarCaso = confirmarEliminarCaso;
    window.verCasoDetalles = verCasoDetalles;
    window.cerrarModal = cerrarModal;
  </script>
</MainLayout>
