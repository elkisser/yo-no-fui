---
import MainLayout from "../layouts/MainLayout.astro";
import {
  Archive,
  FileText,
  Clock,
  CheckCircle,
  Search,
  Download,
  Trash2,
  Filter,
  BarChart3,
  TrendingUp,
  Target,
  AlertCircle,
  ChevronRight,
  Fingerprint,
  Briefcase,
  Users,
  Puzzle,
  Shield,
  Lock,
  X,
  Eye,
} from "lucide-react";
---

<MainLayout>
  <div class="min-h-screen bg-fondo-principal paper-texture" data-guide="archivo-root">
    {/* Fondo decorativo sutil - Estilo expediente */}
    <div class="absolute inset-0 overflow-hidden pointer-events-none">
      <div
        class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-acento-azul/10 to-transparent"
      >
      </div>
      <div
        class="absolute top-20 -left-20 w-96 h-96 bg-acento-azul/2 rounded-full blur-3xl opacity-30"
      >
      </div>
      <div
        class="absolute bottom-20 -right-20 w-96 h-96 bg-acento-turquesa/2 rounded-full blur-3xl opacity-30"
      >
      </div>

      {/* Huellas digitales sutiles */}
      <div class="absolute top-1/4 left-10 w-24 h-36 opacity-5">
        <div
          class="w-8 h-12 rounded-full border border-acento-azul transform rotate-12"
        >
        </div>
      </div>
      <div class="absolute bottom-1/4 right-10 w-24 h-36 opacity-5">
        <div
          class="w-8 h-12 rounded-full border border-acento-turquesa transform -rotate-12"
        >
        </div>
      </div>
    </div>

    <div class="relative z-10 max-w-7xl mx-auto px-4 py-12">
      {/* Header elegante - Estilo expediente */}
      <div class="mb-12">
        <div class="flex items-center gap-6 mb-8">
          <div class="relative">
            {/* Expediente principal */}
            <div
              class="relative w-16 h-16 rounded-xl bg-gradient-to-br from-fondo-panel to-fondo-secundario border-2 border-fondo-borde/60 flex items-center justify-center shadow-xl"
            >
              {/* Clip de carpeta */}
              <div
                class="absolute -top-3 left-1/2 transform -translate-x-1/2 w-10 h-4 bg-gradient-to-b from-gray-600 to-gray-800 rounded-t-lg"
              >
              </div>

              {/* Contenido del expediente */}
              <Archive className="w-8 h-8 text-acento-azul" />

              {/* Tachuelas */}
              <div
                class="absolute -top-1 -left-1 w-3 h-3 rounded-full bg-gradient-to-br from-yellow-600 to-yellow-800"
              >
              </div>
              <div
                class="absolute -top-1 -right-1 w-3 h-3 rounded-full bg-gradient-to-br from-yellow-600 to-yellow-800"
              >
              </div>
            </div>

            {/* Sello oficial */}
            <div
              class="absolute -bottom-2 -right-2 w-8 h-8 rounded-full bg-gradient-to-br from-red-500 to-red-700 flex items-center justify-center border-2 border-fondo-principal"
            >
              <div class="w-2 h-2 rounded-full bg-white"></div>
            </div>
          </div>

          <div class="flex-1">
            <div class="flex items-center gap-3 mb-2">
              <div class="w-4 h-0.5 bg-acento-azul"></div>
              <span
                class="text-sm font-mono text-acento-azul/80 tracking-widest uppercase"
              >
                ARCHIVO CRIMINAL
              </span>
              <div class="w-4 h-0.5 bg-acento-azul"></div>
            </div>

            <h1
              class="text-4xl md:text-5xl font-serif font-bold text-texto-principal mb-3"
            >
              Casos Archivados
            </h1>
            <p class="text-texto-secundario text-lg">
              Historial completo de investigaciones resueltas
            </p>
          </div>
        </div>

        {/* Barra de b√∫squeda y filtros - Estilo interfaz policial */}
        <div class="flex flex-col md:flex-row gap-4 mb-8">
          <div class="flex-1 relative group">
            <div
              class="absolute inset-0 bg-gradient-to-r from-acento-azul/5 to-acento-turquesa/5 rounded-xl blur opacity-0 group-hover:opacity-100 transition-opacity duration-300"
            >
            </div>

            <div class="relative h-12">
              <input
                type="text"
                id="buscar-casos"
                placeholder="üîé Buscar casos por t√≠tulo, ID o fecha..."
                class="h-12 w-full pl-11 pr-4 bg-fondo-panel/30 backdrop-blur-sm border-2 border-fondo-borde/50 rounded-xl text-texto-principal placeholder:text-texto-secundario/50 focus:outline-none focus:border-acento-azul focus:ring-2 focus:ring-acento-azul/20 transition-all duration-300"
              />
            </div>
          </div>

          <div class="flex gap-3">
            <button
              onclick="filtrarCasos('todos')"
              class="h-12 px-5 bg-fondo-panel/30 backdrop-blur-sm border-2 border-fondo-borde/50 rounded-xl text-texto-principal hover:border-acento-azul hover:bg-acento-azul/5 transition-all duration-300 flex items-center gap-2 group action-btn"
            >
              <Filter
                className="w-4 h-4 text-texto-secundario group-hover:text-acento-azul transition-colors"
              />
              <span class="text-sm font-medium">Todos</span>
            </button>

            <button
              onclick="filtrarCasos('resueltos')"
              class="h-12 px-5 bg-fondo-panel/30 backdrop-blur-sm border-2 border-fondo-borde/50 rounded-xl text-texto-principal hover:border-green-500 hover:bg-green-500/5 transition-all duration-300 flex items-center gap-2 group action-btn"
            >
              <CheckCircle
                className="w-4 h-4 text-texto-secundario group-hover:text-green-400 transition-colors"
              />
              <span class="text-sm font-medium">Resueltos</span>
            </button>

            <button
              onclick="filtrarCasos('pendientes')"
              class="h-12 px-5 bg-fondo-panel/30 backdrop-blur-sm border-2 border-fondo-borde/50 rounded-xl text-texto-principal hover:border-yellow-500 hover:bg-yellow-500/5 transition-all duration-300 flex items-center gap-2 group action-btn"
            >
              <Clock
                className="w-4 h-4 text-texto-secundario group-hover:text-yellow-400 transition-colors"
              />
              <span class="text-sm font-medium">Pendientes</span>
            </button>

            <button
              onclick="filtrarCasos('fallidos')"
              class="h-12 px-5 bg-fondo-panel/30 backdrop-blur-sm border-2 border-fondo-borde/50 rounded-xl text-texto-principal hover:border-red-500 hover:bg-red-500/5 transition-all duration-300 flex items-center gap-2 group action-btn"
            >
              <AlertCircle
                className="w-4 h-4 text-texto-secundario group-hover:text-red-400 transition-colors"
              />
              <span class="text-sm font-medium">Fallidos</span>
            </button>

            <button
              onclick="filtrarCasos('abandonados')"
              class="h-12 px-5 bg-fondo-panel/30 backdrop-blur-sm border-2 border-fondo-borde/50 rounded-xl text-texto-principal hover:border-acento-turquesa hover:bg-acento-turquesa/5 transition-all duration-300 flex items-center gap-2 group action-btn"
            >
              <Lock
                className="w-4 h-4 text-texto-secundario group-hover:text-acento-turquesa transition-colors"
              />
              <span class="text-sm font-medium">Abandonados</span>
            </button>
          </div>
        </div>
      </div>

      {/* Contenido principal */}
      <div class="grid lg:grid-cols-3 gap-8">
        {/* Panel izquierdo - Lista de casos */}
        <div class="lg:col-span-2">
          <div
            class="bg-fondo-panel/20 backdrop-blur-sm border-2 border-fondo-borde/50 rounded-2xl overflow-hidden detective-desk"
          >
            {/* Header de la lista */}
            <div
              class="p-6 border-b border-fondo-borde/30 bg-gradient-to-r from-fondo-panel/30 to-transparent"
            >
              <div class="flex items-center justify-between">
                <div>
                  <div class="flex items-center gap-3 mb-2">
                    <div
                      class="w-3 h-3 rounded-full bg-acento-azul animate-pulse"
                    >
                    </div>
                    <h2 class="text-2xl font-serif text-texto-principal">
                      Expedientes
                    </h2>
                  </div>
                  <p class="text-sm text-texto-secundario">
                    <span
                      id="contador-casos"
                      class="font-bold text-texto-principal">0</span
                    > casos encontrados
                  </p>
                </div>

                <div class="flex items-center gap-3">
                  <div class="text-sm text-texto-secundario hidden md:block">
                    Ordenar por:
                  </div>
                  <select
                    id="ordenar-casos"
                    class="px-4 py-2.5 bg-fondo-secundario/30 backdrop-blur-sm border-2 border-fondo-borde/50 rounded-lg text-texto-principal text-sm focus:outline-none focus:border-acento-azul focus:ring-2 focus:ring-acento-azul/20 transition-all duration-300"
                  >
                    <option value="reciente">M√°s reciente</option>
                    <option value="antiguo">M√°s antiguo</option>
                    <option value="titulo">T√≠tulo (A-Z)</option>
                    <option value="estado">Estado</option>
                  </select>
                </div>
              </div>
            </div>

            {/* Lista de casos */}
            <div class="divide-y divide-fondo-borde/30">
              <div id="casos-lista" class="min-h-[400px]">
                <!-- Los casos se cargar√°n aqu√≠ -->
              </div>

              <div id="paginacion-casos" class="hidden px-6 py-4 items-center justify-between border-t border-fondo-borde/30">
                <button
                  id="pagina-prev"
                  type="button"
                  class="h-10 px-4 bg-fondo-panel/20 backdrop-blur-sm border-2 border-fondo-borde/40 rounded-xl text-texto-principal hover:border-acento-azul hover:bg-acento-azul/5 transition-all duration-300 action-btn"
                >
                  Anterior
                </button>
                <div id="pagina-info" class="text-sm text-texto-secundario"></div>
                <button
                  id="pagina-next"
                  type="button"
                  class="h-10 px-4 bg-fondo-panel/20 backdrop-blur-sm border-2 border-fondo-borde/40 rounded-xl text-texto-principal hover:border-acento-azul hover:bg-acento-azul/5 transition-all duration-300 action-btn"
                >
                  Siguiente
                </button>
              </div>

              <!-- Estado vac√≠o -->
              <div id="sin-casos" class="hidden p-12 text-center">
                <div class="max-w-sm mx-auto">
                  <div
                    class="w-24 h-24 mx-auto mb-6 rounded-2xl bg-gradient-to-br from-fondo-borde/20 to-fondo-borde/10 flex items-center justify-center"
                  >
                    <Archive className="w-12 h-12 text-texto-secundario/30" />
                  </div>

                  <h3 class="text-xl font-serif text-texto-principal mb-3">
                    Archivo vac√≠o
                  </h3>

                  <p class="text-texto-secundario mb-8">
                    A√∫n no has resuelto ning√∫n caso. ¬°Comienza una investigaci√≥n
                    para llenar este archivo!
                  </p>

                  <a
                    href="/nuevo-caso"
                    class="inline-flex items-center gap-3 px-8 py-4 bg-gradient-to-r from-acento-azul to-acento-turquesa text-fondo-principal font-bold rounded-xl hover:opacity-90 transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-acento-azul/30 action-btn"
                  >
                    <FileText className="w-5 h-5" />
                    <span>Nuevo caso</span>
                    <ChevronRight className="w-5 h-5" />
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* Panel derecho - Estad√≠sticas y acciones */}
        <div class="space-y-8">
          {/* Tarjeta de estad√≠sticas */}
          <div
            class="bg-fondo-panel/20 backdrop-blur-sm border-2 border-fondo-borde/50 rounded-2xl p-6 detective-desk"
            data-guide="archivo-stats-card"
          >
            <div class="flex items-center gap-3 mb-6">
              <div
                class="w-12 h-12 rounded-xl bg-gradient-to-br from-acento-azul/20 to-acento-turquesa/20 border border-acento-azul/30 flex items-center justify-center"
              >
                <BarChart3 className="w-6 h-6 text-acento-azul" />
              </div>
              <h3 class="text-xl font-serif text-texto-principal">
                Estad√≠sticas
              </h3>
            </div>

            <div class="space-y-5">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <Fingerprint className="w-5 h-5 text-texto-secundario" />
                  <span class="text-texto-secundario">Casos totales</span>
                </div>
                <span
                  class="text-2xl font-bold text-texto-principal"
                  id="total-casos">0</span
                >
              </div>

              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <CheckCircle className="w-5 h-5 text-green-400" />
                  <span class="text-texto-secundario">Resueltos</span>
                </div>
                <span
                  class="text-2xl font-bold text-green-400"
                  id="casos-resueltos">0</span
                >
              </div>

              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <Clock className="w-5 h-5 text-yellow-400" />
                  <span class="text-texto-secundario">Pendientes</span>
                </div>
                <span
                  class="text-2xl font-bold text-yellow-400"
                  id="casos-pendientes">0</span
                >
              </div>

              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <AlertCircle className="w-5 h-5 text-red-400" />
                  <span class="text-texto-secundario">Fallidos</span>
                </div>
                <span
                  class="text-2xl font-bold text-red-400"
                  id="casos-fallidos">0</span
                >
              </div>

              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <Lock className="w-5 h-5 text-blue-400" />
                  <span class="text-texto-secundario">Abandonados</span>
                </div>
                <span
                  class="text-2xl font-bold text-blue-400"
                  id="casos-abandonados">0</span
                >
              </div>

              <div class="pt-4 border-t border-fondo-borde/30">
                <div class="flex items-center justify-between mb-2">
                  <div class="flex items-center gap-3">
                    <TrendingUp className="w-5 h-5 text-acento-turquesa" />
                    <span class="text-texto-secundario">Tasa de √©xito</span>
                  </div>
                  <span
                    class="text-2xl font-bold text-acento-turquesa"
                    id="tasa-exito">0%</span
                  >
                </div>
                <div
                  class="w-full h-2 bg-fondo-borde/50 rounded-full overflow-hidden"
                >
                  <div
                    id="barra-exito"
                    class="h-full bg-gradient-to-r from-acento-azul to-acento-turquesa rounded-full transition-all duration-1000"
                    style="width: 0%"
                  >
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* Tarjeta de caso activo */}
          <div
            id="tarjeta-activo"
            class="hidden bg-gradient-to-br from-acento-azul/10 to-acento-turquesa/10 border-2 border-acento-azul/30 rounded-2xl p-6 detective-desk"
          >
            <div class="flex items-center gap-3 mb-4">
              <div
                class="w-10 h-10 rounded-lg bg-acento-azul/20 border border-acento-azul/30 flex items-center justify-center"
              >
                <Target className="w-5 h-5 text-acento-azul" />
              </div>
              <h3 class="text-lg font-serif text-texto-principal">
                Caso activo
              </h3>
              <div
                class="ml-auto w-3 h-3 rounded-full bg-green-400 animate-pulse"
              >
              </div>
            </div>

            <div class="mb-4">
              <h4
                id="titulo-activo"
                class="text-texto-principal font-medium mb-1 truncate"
              >
              </h4>
              <p class="text-sm text-texto-secundario">
                <span id="tiempo-activo"></span> de investigaci√≥n
              </p>
            </div>

            <a
              href="/investigar"
              class="block w-full py-3 bg-gradient-to-r from-acento-azul to-acento-turquesa text-fondo-principal text-center font-bold rounded-lg hover:opacity-90 transition-opacity shadow-lg hover:shadow-acento-azul/30 action-btn"
            >
              Continuar investigaci√≥n
            </a>
          </div>

          {/* Tarjeta de acciones */}
          <div
            class="bg-fondo-panel/20 backdrop-blur-sm border-2 border-fondo-borde/50 rounded-2xl p-6 detective-desk"
          >
            <div class="flex items-center gap-3 mb-6">
              <Briefcase className="w-6 h-6 text-acento-azul" />
              <h3 class="text-lg font-serif text-texto-principal">
                Gesti√≥n del archivo
              </h3>
            </div>

            <div class="space-y-4">
              <button
                onclick="exportarHistorial()"
                data-guide="archivo-exportar"
                class="w-full py-3.5 bg-fondo-secundario/30 backdrop-blur-sm border-2 border-fondo-borde/50 rounded-xl text-texto-principal hover:border-acento-azul hover:bg-acento-azul/5 transition-all duration-300 flex items-center justify-center gap-3 group action-btn"
              >
                <Download
                  className="w-5 h-5 text-texto-secundario group-hover:text-acento-azul transition-colors"
                />
                <span class="font-bold">Exportar historial</span>
              </button>

              <button
                onclick="limpiarHistorial()"
                data-guide="archivo-limpiar"
                class="w-full py-3.5 bg-red-500/10 backdrop-blur-sm border-2 border-red-500/20 rounded-xl text-red-400 hover:bg-red-500/20 hover:border-red-500/40 transition-all duration-300 flex items-center justify-center gap-3 group action-btn"
              >
                <Trash2
                  className="w-5 h-5 group-hover:scale-110 transition-transform"
                />
                <span class="font-bold">Limpiar archivo</span>
              </button>
            </div>

            <div class="mt-6 pt-6 border-t border-fondo-borde/30">
              <div class="flex items-start gap-3">
                <AlertCircle
                  className="w-5 h-5 text-texto-secundario/60 flex-shrink-0 mt-0.5"
                />
                <p class="text-xs text-texto-secundario/60 leading-relaxed">
                  Los casos se guardan localmente en tu dispositivo. Puedes exportarlos para respaldarlos.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Confirmaci√≥n -->
  <div
    id="modal-confirmacion"
    class="fixed inset-0 z-50 hidden transition-all duration-300 opacity-0 pointer-events-none"
  >
    <div
      class="absolute inset-0 bg-black/60 backdrop-blur-sm"
      onclick="cerrarModal()"
    >
    </div>
    <div
      class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-md p-6 bg-fondo-panel border-2 border-fondo-borde rounded-2xl shadow-2xl scale-95 transition-all duration-300 detective-desk"
      id="modal-content"
    >
      <div class="flex items-center gap-3 mb-4" id="modal-header">
        <!-- Icono din√°mico -->
      </div>

      <h3
        id="modal-titulo"
        class="text-xl font-serif text-texto-principal mb-2"
      >
      </h3>
      <div id="modal-mensaje" class="text-texto-secundario mb-8 leading-relaxed">
      </div>

      <div class="flex justify-end gap-3">
        <button
          onclick="cerrarModal()"
          class="px-5 py-2.5 rounded-xl border-2 border-fondo-borde text-texto-secundario hover:text-texto-principal hover:bg-fondo-secundario/30 transition-all duration-200 font-medium action-btn"
        >
          Cancelar
        </button>
        <button
          id="modal-accion-btn"
          class="px-5 py-2.5 rounded-xl text-fondo-principal font-bold shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105 action-btn"
        >
          Confirmar
        </button>
      </div>
    </div>
  </div>

  <style>
    /* Animaciones */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-fade-in-up {
      animation: fadeInUp 0.5s ease-out forwards;
    }

    /* Clases para el modal activo */
    #modal-confirmacion.activo {
      opacity: 1;
      pointer-events: auto;
    }

    #modal-confirmacion.activo #modal-content {
      transform: translate(-50%, -50%) scale(100%);
    }

    /* Efectos hover para tarjetas */
    .caso-card {
      transition: all 0.3s ease;
      position: relative;
    }

    .caso-card:hover {
      background: linear-gradient(
        90deg,
        rgba(77, 163, 255, 0.05) 0%,
        rgba(94, 234, 212, 0.02) 100%
      );
      border-color: rgba(77, 163, 255, 0.3);
      transform: translateX(4px);
    }

    .caso-card::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: linear-gradient(
        to bottom,
        transparent,
        var(--tw-gradient-stops),
        transparent
      );
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .caso-card:hover::before {
      opacity: 1;
      background: linear-gradient(to bottom, transparent, #4da3ff, transparent);
    }

    .action-btn.active {
      /* El color espec√≠fico lo define active-<tipo> */
    }

    .action-btn.active-todos {
      border-color: #4da3ff;
      background-color: rgba(77, 163, 255, 0.08);
    }

    .action-btn.active-resueltos {
      border-color: rgb(74 222 128);
      background-color: rgba(74, 222, 128, 0.10);
    }

    .action-btn.active-pendientes {
      border-color: rgb(250 204 21);
      background-color: rgba(250, 204, 21, 0.10);
    }

    .action-btn.active-fallidos {
      border-color: rgb(248 113 113);
      background-color: rgba(248, 113, 113, 0.10);
    }

    .action-btn.active-abandonados {
      /* Fallback a turquesa si la variable no existe */
      border-color: var(--acento-turquesa, #5eead4);
      background-color: rgba(94, 234, 212, 0.10);
    }

    .action-btn.active-todos svg,
    .action-btn.active-todos span {
      color: var(--acento-azul);
    }

    .action-btn.active-resueltos svg,
    .action-btn.active-resueltos span {
      color: rgb(74 222 128);
    }

    .action-btn.active-pendientes svg,
    .action-btn.active-pendientes span {
      color: rgb(250 204 21);
    }

    .action-btn.active-fallidos svg,
    .action-btn.active-fallidos span {
      color: rgb(248 113 113);
    }

    .action-btn.active-abandonados svg,
    .action-btn.active-abandonados span {
      color: var(--acento-turquesa, #5eead4) !important;
    }
  </style>

  <script>
    // Variables globales
    let historialOriginal: any[] = [];
    let historialFiltrado: any[] = [];

    const LS_GUIDE_REQUEST = 'yo-no-fui-guide-request';
    const GUIDE_EVENT = 'yo-no-fui:guide';
    let filtroActual = "todos";
    let accionPendiente = null;

    const LS_ARCHIVO_FILTRO = 'yo-no-fui-archivo-filtro';
    const PAGE_SIZE = 6;
    let paginaActual = 1;

    // Cargar historial de casos
    function cargarHistorial() {
      try {
        historialOriginal = JSON.parse(
          localStorage.getItem("historial-casos") || "[]"
        );
        aplicarFiltro();
        mostrarCasoActivo();
      } catch (error) {
        console.error("Error cargando historial:", error);
        historialOriginal = [];
        mostrarSinCasos();
      }
    }

    // Aplicar filtro actual
    function aplicarFiltro() {
      const contador = document.getElementById("contador-casos");

      switch (filtroActual) {
        case "resueltos":
          historialFiltrado = historialOriginal.filter((c) => c.resuelto || c.estado === 'resuelto');
          break;
        case "pendientes":
          historialFiltrado = historialOriginal.filter((c) => {
            const estado = c.estado;
            if (estado) return estado === 'pendiente';
            return !c.resuelto;
          });
          break;
        case "fallidos":
          historialFiltrado = historialOriginal.filter((c) => c.estado === 'fallido');
          break;
        case "abandonados":
          historialFiltrado = historialOriginal.filter((c) => c.estado === 'abandonado');
          break;
        case "todos":
        default:
          historialFiltrado = [...historialOriginal];
      }

      // Aplicar b√∫squeda si existe
      const busquedaInput = document.getElementById("buscar-casos");
      if (busquedaInput && (busquedaInput as HTMLInputElement).value) {
        const term = (busquedaInput as HTMLInputElement).value.toLowerCase();
        historialFiltrado = historialFiltrado.filter(
          (caso) =>
            (caso.titulo && caso.titulo.toLowerCase().includes(term)) ||
            (caso.casoId && caso.casoId.toLowerCase().includes(term)) ||
            (caso.fecha && caso.fecha.toLowerCase().includes(term))
        );
      }

      // Aplicar orden
      const ordenInput = document.getElementById("ordenar-casos");
      if (ordenInput) {
        ordenarCasos((ordenInput as HTMLSelectElement).value);
      }

      if (contador) contador.textContent = String(historialFiltrado.length);
      actualizarEstadisticas();

      // Resetear a p√°gina 1 cuando cambia el dataset
      paginaActual = 1;

      if (historialFiltrado.length === 0) {
        mostrarSinCasos();
      } else {
        mostrarCasos();
      }
    }

    function totalPaginas() {
      return Math.max(1, Math.ceil(historialFiltrado.length / PAGE_SIZE));
    }

    function setPagina(nuevaPagina: number) {
      const total = totalPaginas();
      paginaActual = Math.min(Math.max(1, nuevaPagina), total);
      mostrarCasos();
    }

    // Ordenar casos
    function ordenarCasos(orden: string) {
      const getFechaMs = (obj: any) => {
        const raw = obj?.fecha || obj?.fechaCreacion || obj?.creadoEn;
        if (!raw) return 0;
        const ms = new Date(raw).getTime();
        return Number.isNaN(ms) ? 0 : ms;
      };

      const getEstado = (obj: any) => {
        return obj?.estado || (obj?.resuelto ? 'resuelto' : 'pendiente');
      };

      const estadoOrden: Record<string, number> = {
        pendiente: 0,
        resuelto: 1,
        fallido: 2,
        abandonado: 3,
      };

      historialFiltrado.sort((a, b) => {
        switch (orden) {
          case "antiguo":
            return getFechaMs(a) - getFechaMs(b);
          case "titulo":
            return (a.titulo || "").localeCompare(b.titulo || "");
          case "estado":
            return (estadoOrden[getEstado(a)] ?? 99) - (estadoOrden[getEstado(b)] ?? 99);
          case "reciente":
          default:
            return getFechaMs(b) - getFechaMs(a);
        }
      });
    }

    // Mostrar lista de casos
    function mostrarCasos() {
      const casosLista = document.getElementById("casos-lista");
      const sinCasos = document.getElementById("sin-casos");
      const paginacion = document.getElementById("paginacion-casos");
      const btnPrev = document.getElementById("pagina-prev") as HTMLButtonElement | null;
      const btnNext = document.getElementById("pagina-next") as HTMLButtonElement | null;
      const paginaInfo = document.getElementById("pagina-info");

      if (sinCasos) sinCasos.classList.add("hidden");
      if (casosLista) {
        const total = historialFiltrado.length;
        const totalPags = totalPaginas();
        const start = (paginaActual - 1) * PAGE_SIZE;
        const end = start + PAGE_SIZE;
        const casosPagina = historialFiltrado.slice(start, end);

        casosLista.classList.remove("hidden");
        casosLista.innerHTML = casosPagina
          .map((caso, index) => {
            const guideVer = index === 0 ? ' data-guide="archivo-ver"' : '';
            const guideBorrar = index === 0 ? ' data-guide="archivo-borrar"' : '';
            const estado = (caso.estado || (caso.resuelto ? 'resuelto' : 'pendiente')) as string;
            const badgeMap = {
              resuelto: {
                dot: 'bg-green-400',
                pill: 'bg-green-400/10 text-green-400 border border-green-400/30',
                label: 'RESUELTO'
              },
              pendiente: {
                dot: 'bg-yellow-400',
                pill: 'bg-yellow-400/10 text-yellow-400 border border-yellow-400/30',
                label: 'PENDIENTE'
              },
              fallido: {
                dot: 'bg-red-400',
                pill: 'bg-red-400/10 text-red-400 border border-red-400/30',
                label: 'FALLIDO'
              },
              abandonado: {
                dot: 'bg-blue-400',
                pill: 'bg-blue-400/10 text-blue-400 border border-blue-400/30',
                label: 'ABANDONADO'
              }
            } as const;
            const badge = (badgeMap as any)[estado] || {
              dot: 'bg-yellow-400',
              pill: 'bg-yellow-400/10 text-yellow-400 border border-yellow-400/30',
              label: 'PENDIENTE'
            };

            // Formatear fecha correctamente
            let fechaFormateada = "Fecha desconocida";
            let tiempo = "";

            if (caso.fechaCreacion) {
              const fecha = new Date(caso.fechaCreacion);
              fechaFormateada = fecha.toLocaleDateString("es-ES", {
                day: "numeric",
                month: "short",
                year: "numeric",
              });
              tiempo = fecha.toLocaleTimeString("es-ES", {
                hour: "2-digit",
                minute: "2-digit",
              });
            } else if (caso.fecha) {
              fechaFormateada = caso.fecha;
            }

            // Mostrar ID m√°s corto para mejor visualizaci√≥n
            const casoIdCorto = caso.casoId
              ? `${caso.casoId.substring(0, 8)}...`
              : "Sin ID";

            return `
            <div class="caso-card p-5 border-b border-fondo-borde/30 last:border-b-0 animate-fade-in-up group/card" 
                 style="animation-delay: ${index * 0.05}s">
              <div class="flex items-start justify-between">
                <div class="flex-1 min-w-0 pr-4">
                  <div class="flex items-center gap-3 mb-3">
                    <div class="flex items-center gap-2">
                      <div class="w-2 h-2 rounded-full ${badge.dot} animate-pulse"></div>
                      <span class="text-xs font-bold px-3 py-1 rounded-full ${badge.pill}">
                        ${badge.label}
                      </span>
                    </div>
                    
                    <span class="text-xs text-texto-secundario/70 font-mono">
                      ${fechaFormateada} ${tiempo ? `‚Ä¢ ${tiempo}` : ""}
                    </span>
                  </div>
                  
                  <h3 class="text-lg font-bold text-texto-principal mb-2 truncate group-hover/card:text-acento-azul transition-colors">
                    ${caso.titulo || "Caso sin t√≠tulo"}
                  </h3>
                  
                  <div class="flex items-center gap-4 text-sm text-texto-secundario">
                    <div class="flex items-center gap-1.5 min-w-0">
                      <Fingerprint class="w-4 h-4" />
                      <span class="truncate font-mono">ID: ${casoIdCorto}</span>
                    </div>
                    
                    ${
                      caso.tiempoResolucion
                        ? `
                      <div class="flex items-center gap-1.5 whitespace-nowrap">
                        <Clock class="w-4 h-4" />
                        <span>${caso.tiempoResolucion}</span>
                      </div>
                    `
                        : ""
                    }
                    
                    ${
                      caso.dificultad
                        ? `
                      <div class="flex items-center gap-1.5">
                        <Shield class="w-4 h-4" />
                        <span>${caso.dificultad}</span>
                      </div>
                    `
                        : ""
                    }
                  </div>
                  
                  ${
                    caso.descripcion
                      ? `
                    <p class="mt-3 text-sm text-texto-secundario/80 line-clamp-2">
                      ${caso.descripcion}
                    </p>
                  `
                      : ""
                  }
                </div>
                
                <div class="flex flex-col items-center gap-2 ml-4">
                  ${
                    estado === 'abandonado'
                      ? `
                        <button 
                          onclick="confirmarEliminarCaso('${caso.casoId}', '${caso.titulo || "este caso"}')"
                          ${guideBorrar}
                          class="p-2 text-texto-secundario hover:text-red-400 hover:bg-red-500/10 rounded-lg transition-all duration-300 focus:opacity-100"
                          title="Eliminar caso"
                        >
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                        </button>
                      `
                      : `
                        <button 
                          onclick="verCasoResultado('${caso.casoId}')"
                          ${guideVer}
                          class="p-2 text-texto-secundario hover:text-acento-azul hover:bg-acento-azul/10 rounded-lg transition-all duration-300 focus:opacity-100 flex items-center gap-1"
                          title="Ver resultado"
                        >
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0"/><circle cx="12" cy="12" r="3"/></svg>
                        </button>
                        
                        <button 
                          onclick="confirmarEliminarCaso('${caso.casoId}', '${caso.titulo || "este caso"}')"
                          ${guideBorrar}
                          class="p-2 text-texto-secundario hover:text-red-400 hover:bg-red-500/10 rounded-lg transition-all duration-300 focus:opacity-100"
                          title="Eliminar caso"
                        >
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                        </button>
                      `
                  }
                </div>
              </div>
            </div>
          `;
          })
          .join("");

        if (paginacion) {
          if (total > PAGE_SIZE) {
            paginacion.classList.remove("hidden");
            paginacion.classList.add("flex");
            if (paginaInfo) paginaInfo.textContent = `P√°gina ${paginaActual} de ${totalPags}`;

            if (btnPrev) {
              btnPrev.disabled = paginaActual <= 1;
              btnPrev.classList.toggle('opacity-50', btnPrev.disabled);
              btnPrev.classList.toggle('pointer-events-none', btnPrev.disabled);
            }

            if (btnNext) {
              btnNext.disabled = paginaActual >= totalPags;
              btnNext.classList.toggle('opacity-50', btnNext.disabled);
              btnNext.classList.toggle('pointer-events-none', btnNext.disabled);
            }
          } else {
            paginacion.classList.add("hidden");
            paginacion.classList.remove("flex");
          }
        }
      }
    }

    // Mostrar estado vac√≠o
    function mostrarSinCasos() {
      const casosLista = document.getElementById("casos-lista");
      const sinCasos = document.getElementById("sin-casos");

      if (casosLista) casosLista.classList.add("hidden");
      if (sinCasos) sinCasos.classList.remove("hidden");
    }

    // Actualizar estad√≠sticas
    function actualizarEstadisticas() {
      const total = historialOriginal.length;
      const resueltos = historialOriginal.filter((c) => c.resuelto || c.estado === 'resuelto').length;
      const fallidos = historialOriginal.filter((c) => c.estado === 'fallido').length;
      const abandonados = historialOriginal.filter((c) => c.estado === 'abandonado').length;
      const pendientes = historialOriginal.filter((c) => {
        const estado = c.estado;
        if (estado) return estado === 'pendiente';
        return !c.resuelto;
      }).length;
      const tasa = total > 0 ? Math.round((resueltos / total) * 100) : 0;

      // Actualizar n√∫meros
      const els = {
        total: document.getElementById("total-casos"),
        resueltos: document.getElementById("casos-resueltos"),
        pendientes: document.getElementById("casos-pendientes"),
        fallidos: document.getElementById("casos-fallidos"),
        abandonados: document.getElementById("casos-abandonados"),
        tasa: document.getElementById("tasa-exito"),
        barra: document.getElementById("barra-exito"),
      };

      if (els.total) els.total.textContent = String(total);
      if (els.resueltos) els.resueltos.textContent = String(resueltos);
      if (els.pendientes) els.pendientes.textContent = String(pendientes);
      if (els.fallidos) els.fallidos.textContent = String(fallidos);
      if (els.abandonados) els.abandonados.textContent = String(abandonados);
      if (els.tasa) els.tasa.textContent = `${tasa}%`;

      // Animar barra de progreso
      if (els.barra) {
        (els.barra as HTMLElement).style.width = "0%";
        setTimeout(() => {
          (els.barra as HTMLElement).style.width = `${tasa}%`;
        }, 100);
      }
    }

    // Mostrar caso activo si existe
    function mostrarCasoActivo() {
      const tarjeta = document.getElementById("tarjeta-activo");
      const storeData = localStorage.getItem("yo-no-fui-storage");

      if (tarjeta && storeData) {
        try {
          const parsedStore = JSON.parse(storeData);
          const caso = parsedStore.state?.casoActual;

          // Verificar que sea un caso activo real (no resuelto)
          const casoEnHistorial = historialOriginal.find(
            (c) => c.casoId === caso?.id
          );
          const estaResuelto = casoEnHistorial?.resuelto || caso?.resuelto;

          if (caso && caso.titulo && caso.id && !estaResuelto) {
            const tiempoInicio = parsedStore.state.tiempoInicio
              ? new Date(parsedStore.state.tiempoInicio)
              : new Date();
            const ahora = new Date();
            const diffMs = ahora.getTime() - tiempoInicio.getTime();
            const diffMinutos = Math.floor(diffMs / (1000 * 60));
            const diffHoras = Math.floor(diffMinutos / 60);
            const minutosRestantes = diffMinutos % 60;

            const tituloEl = document.getElementById("titulo-activo");
            const tiempoEl = document.getElementById("tiempo-activo");

            if (tituloEl) tituloEl.textContent = caso.titulo;
            if (tiempoEl) {
              tiempoEl.textContent =
                diffHoras > 0
                  ? `${diffHoras}h ${minutosRestantes}m`
                  : `${minutosRestantes}m`;
            }

            tarjeta.classList.remove("hidden");
          } else {
            tarjeta.classList.add("hidden");
          }
        } catch (error) {
          console.error("Error parsing game store:", error);
          tarjeta.classList.add("hidden");
        }
      } else if (tarjeta) {
        tarjeta.classList.add("hidden");
      }
    }

    // L√≥gica del MODAL
    function abrirModal(tipo: string, titulo: string, mensaje: string, accion: null | (() => void)) {
      const modal = document.getElementById("modal-confirmacion");
      const modalTitulo = document.getElementById("modal-titulo");
      const modalMensaje = document.getElementById("modal-mensaje");
      const modalBtn = document.getElementById("modal-accion-btn");
      const modalHeader = document.getElementById("modal-header");

      if (!modal) return;

      if (!modalTitulo || !modalMensaje || !modalBtn || !modalHeader) return;

      modalTitulo.textContent = titulo;
      (modalMensaje as HTMLElement).textContent = mensaje;

      // Resetear clases del bot√≥n
      (modalBtn as HTMLElement).className =
        "px-5 py-2.5 rounded-xl font-bold shadow-lg transition-all duration-200 transform hover:scale-105 action-btn";

      // Remove old event listeners by cloning
      const newBtn = (modalBtn as HTMLElement).cloneNode(true) as HTMLButtonElement;
      if ((modalBtn as HTMLElement).parentNode) {
        (modalBtn as HTMLElement).parentNode!.replaceChild(newBtn, modalBtn);
      }

      // Add new listener
      if (accion) {
        newBtn.onclick = () => {
          accion();
          cerrarModal();
        };
      } else {
        newBtn.onclick = cerrarModal;
      }

      if (tipo === "peligro") {
        newBtn.classList.add(
          "bg-gradient-to-r",
          "from-red-500",
          "to-red-600",
          "text-white",
          "hover:shadow-red-500/30"
        );
        newBtn.textContent = "Eliminar";
        (modalHeader as HTMLElement).innerHTML = `<div class="w-10 h-10 rounded-full bg-red-500/20 flex items-center justify-center text-red-500 border-2 border-red-500/30">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
        </div>`;
      } else if (tipo === "info") {
        newBtn.classList.add(
          "bg-gradient-to-r",
          "from-acento-azul",
          "to-acento-turquesa",
          "text-fondo-principal",
          "hover:shadow-acento-azul/30"
        );
        newBtn.textContent = "Continuar";
        (modalHeader as HTMLElement).innerHTML = `<div class="w-10 h-10 rounded-full bg-acento-azul/20 flex items-center justify-center text-acento-azul border-2 border-acento-azul/30">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        </div>`;
      } else {
        newBtn.classList.add(
          "bg-gradient-to-r",
          "from-acento-azul",
          "to-acento-turquesa",
          "text-fondo-principal",
          "hover:shadow-acento-azul/30"
        );
        newBtn.textContent = "Aceptar";
        (modalHeader as HTMLElement).innerHTML = `<div class="w-10 h-10 rounded-full bg-acento-azul/20 flex items-center justify-center text-acento-azul border-2 border-acento-azul/30">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
        </div>`;
      }

      modal.classList.remove("hidden");
      setTimeout(() => modal.classList.add("activo"), 10);
    }

    function abrirModalResultado(caso: any) {
      const modal = document.getElementById("modal-confirmacion");
      const modalTitulo = document.getElementById("modal-titulo");
      const modalMensaje = document.getElementById("modal-mensaje");
      const modalBtn = document.getElementById("modal-accion-btn") as HTMLButtonElement | null;
      const modalHeader = document.getElementById("modal-header");

      if (!modal || !modalTitulo || !modalMensaje || !modalBtn || !modalHeader) return;

      const estado = caso.estado || (caso.resuelto ? 'resuelto' : 'pendiente');
      const tituloCaso = caso.titulo || 'Caso sin t√≠tulo';

      const estadoUI: Record<string, any> = {
        resuelto: {
          badge: '‚úÖ Resuelto',
          ring: 'border-green-500/30',
          headerBg: 'bg-green-500/10',
          title: 'text-green-400',
          btn: ['from-green-500', 'to-green-600', 'text-white', 'hover:shadow-green-500/30'],
          icon: `<div class="w-10 h-10 rounded-full bg-green-500/20 flex items-center justify-center text-green-400 border-2 border-green-500/30">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>
          </div>`,
        },
        fallido: {
          badge: '‚ùå Fallido',
          ring: 'border-red-500/30',
          headerBg: 'bg-red-500/10',
          title: 'text-red-400',
          btn: ['from-red-500', 'to-red-600', 'text-white', 'hover:shadow-red-500/30'],
          icon: `<div class="w-10 h-10 rounded-full bg-red-500/20 flex items-center justify-center text-red-400 border-2 border-red-500/30">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
          </div>`,
        },
        pendiente: {
          badge: '‚è≥ Pendiente',
          ring: 'border-yellow-500/30',
          headerBg: 'bg-yellow-500/10',
          title: 'text-yellow-400',
          btn: ['from-yellow-500', 'to-yellow-600', 'text-fondo-principal', 'hover:shadow-yellow-500/30'],
          icon: `<div class="w-10 h-10 rounded-full bg-yellow-500/20 flex items-center justify-center text-yellow-400 border-2 border-yellow-500/30">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
          </div>`,
        },
        abandonado: {
          badge: 'üìÅ Abandonado',
          ring: 'border-acento-turquesa/30',
          headerBg: 'bg-acento-turquesa/10',
          title: 'text-acento-turquesa',
          btn: ['from-acento-azul', 'to-acento-turquesa', 'text-fondo-principal', 'hover:shadow-acento-azul/30'],
          icon: `<div class="w-10 h-10 rounded-full bg-acento-turquesa/20 flex items-center justify-center text-acento-turquesa border-2 border-acento-turquesa/30">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-7a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v7"/><path d="M4 7a2 2 0 0 1 2-2h3.5l1.5 2H18a2 2 0 0 1 2 2v3H4V7Z"/></svg>
          </div>`,
        },
      };

      const ui = estadoUI[estado] || estadoUI.pendiente;

      modalTitulo.textContent = tituloCaso;
      modalHeader.innerHTML = `${ui.icon}
        <div class="flex-1">
          <div class="text-sm font-mono tracking-widest uppercase ${ui.title}">Resultado del expediente</div>
          <div class="mt-1 inline-flex items-center px-3 py-1 rounded-full ${ui.headerBg} ${ui.ring} border text-xs font-bold">${ui.badge}</div>
        </div>`;

      const formatDate = (value: any) => {
        if (!value) return '‚Äî';
        try {
          const d = new Date(value);
          if (Number.isNaN(d.getTime())) return '‚Äî';
          return d.toLocaleString('es-AR', {
            year: 'numeric',
            month: 'short',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
          });
        } catch {
          return '‚Äî';
        }
      };

      const id = caso.casoId || caso.id || '‚Äî';
      const fechaStr = formatDate(caso.fecha || caso.fechaCreacion || caso.creadoEn);

      const duracion = caso.tiempo || caso.tiempoResolucion || caso.stats?.tiempoTotal || '‚Äî';
      const dificultad = caso.dificultad || caso.data?.configuracion?.complejidad || caso.data?.dificultad || '‚Äî';
      const errores = (typeof caso.stats?.erroresCometidos === 'number')
        ? String(caso.stats.erroresCometidos)
        : (typeof caso.errores === 'number' ? String(caso.errores) : '‚Äî');
      const ayudas = (typeof caso.stats?.ayudasUtilizadas === 'number') ? String(caso.stats.ayudasUtilizadas) : '‚Äî';
      const puntaje = (typeof caso.stats?.puntaje === 'number') ? String(caso.stats.puntaje) : '‚Äî';
      const culpable = caso.culpable || caso.data?.culpable || caso.data?.culpableNombre || '‚Äî';
      const ambientacion = caso.data?.ambientacion || caso.ambientacion || '‚Äî';

      (modalMensaje as HTMLElement).innerHTML = `
        <div class="rounded-2xl border ${ui.ring} ${ui.headerBg} p-4">
          <div class="mb-4">
            <div class="text-xs text-texto-secundario">Ambientaci√≥n</div>
            <div class="text-sm text-texto-principal/90 leading-relaxed">${String(ambientacion)}</div>
          </div>

          <div class="grid grid-cols-2 gap-3 text-sm">
            <div class="rounded-xl bg-fondo-panel/20 border border-fondo-borde/30 p-3">
              <div class="text-xs text-texto-secundario">ID</div>
              <div class="font-mono text-texto-principal truncate">${id}</div>
            </div>
            <div class="rounded-xl bg-fondo-panel/20 border border-fondo-borde/30 p-3">
              <div class="text-xs text-texto-secundario">Fecha</div>
              <div class="text-texto-principal">${fechaStr}</div>
            </div>
            <div class="rounded-xl bg-fondo-panel/20 border border-fondo-borde/30 p-3">
              <div class="text-xs text-texto-secundario">Duraci√≥n</div>
              <div class="text-texto-principal">${duracion}</div>
            </div>
            <div class="rounded-xl bg-fondo-panel/20 border border-fondo-borde/30 p-3">
              <div class="text-xs text-texto-secundario">Dificultad</div>
              <div class="text-texto-principal">${dificultad}</div>
            </div>
            <div class="rounded-xl bg-fondo-panel/20 border border-fondo-borde/30 p-3">
              <div class="text-xs text-texto-secundario">Errores</div>
              <div class="text-texto-principal">${errores}</div>
            </div>
            <div class="rounded-xl bg-fondo-panel/20 border border-fondo-borde/30 p-3">
              <div class="text-xs text-texto-secundario">Culpable</div>
              <div class="text-texto-principal truncate">${culpable}</div>
            </div>
            <div class="rounded-xl bg-fondo-panel/20 border border-fondo-borde/30 p-3">
              <div class="text-xs text-texto-secundario">Ayudas</div>
              <div class="text-texto-principal">${ayudas}</div>
            </div>
            <div class="rounded-xl bg-fondo-panel/20 border border-fondo-borde/30 p-3">
              <div class="text-xs text-texto-secundario">Puntaje</div>
              <div class="text-texto-principal">${puntaje}</div>
            </div>
          </div>

          ${(caso.descripcion || caso.data?.descripcion || caso.data?.resumen) ? `
            <div class="mt-4 pt-4 border-t border-fondo-borde/30">
              <div class="text-xs text-texto-secundario mb-2">Resumen</div>
              <div class="text-sm text-texto-principal/90 leading-relaxed">${String(caso.descripcion || caso.data?.descripcion || caso.data?.resumen)}</div>
            </div>
          ` : ''}
        </div>
      `;

      modalBtn.className = "px-5 py-2.5 rounded-xl font-bold shadow-lg transition-all duration-200 transform hover:scale-105 action-btn bg-gradient-to-r";
      modalBtn.classList.add(...ui.btn);
      modalBtn.textContent = "Cerrar";
      modalBtn.onclick = cerrarModal;

      modal.classList.remove("hidden");
      setTimeout(() => modal.classList.add("activo"), 10);
    }

    function cerrarModal() {
      const modal = document.getElementById("modal-confirmacion");
      if (!modal) return;

      modal.classList.remove("activo");
      setTimeout(() => modal.classList.add("hidden"), 300);
    }

    // Funciones de filtro
    function filtrarCasos(tipo: string) {
      // Si vuelve a tocar el filtro activo, lo desactiva volviendo a "todos"
      if (tipo === filtroActual && tipo !== 'todos') {
        tipo = 'todos';
      }

      filtroActual = tipo;
      aplicarFiltro();

      try {
        localStorage.setItem(LS_ARCHIVO_FILTRO, tipo);
      } catch (_) {
        // ignore
      }

      // Remover clase activa de todos los botones
      document
        .querySelectorAll('button[onclick^="filtrarCasos"]')
        .forEach((btn) => {
          (btn as HTMLElement).classList.remove(
            "bg-acento-azul/10",
            "border-acento-azul",
            "bg-green-500/10",
            "border-green-500",
            "bg-yellow-500/10",
            "border-yellow-500",
            "bg-red-500/10",
            "border-red-500",
            "bg-acento-turquesa/10",
            "border-acento-turquesa",
            "active",
            "active-todos",
            "active-resueltos",
            "active-pendientes",
            "active-fallidos",
            "active-abandonados"
          );
        });

      // Agregar clase activa al bot√≥n seleccionado
      const botonActual = document.querySelector(
        `button[onclick="filtrarCasos('${tipo}')"]`
      );
      if (botonActual) {
        (botonActual as HTMLElement).classList.add('active');
        if (tipo === "todos") {
          (botonActual as HTMLElement).classList.add("bg-acento-azul/10", "border-acento-azul");
          (botonActual as HTMLElement).classList.add("active-todos");
        } else if (tipo === "resueltos") {
          (botonActual as HTMLElement).classList.add("bg-green-500/10", "border-green-500");
          (botonActual as HTMLElement).classList.add("active-resueltos");
        } else if (tipo === "pendientes") {
          (botonActual as HTMLElement).classList.add("bg-yellow-500/10", "border-yellow-500");
          (botonActual as HTMLElement).classList.add("active-pendientes");
        } else if (tipo === "fallidos") {
          (botonActual as HTMLElement).classList.add("bg-red-500/10", "border-red-500");
          (botonActual as HTMLElement).classList.add("active-fallidos");
        } else if (tipo === "abandonados") {
          (botonActual as HTMLElement).classList.add("bg-acento-turquesa/10", "border-acento-turquesa");
          (botonActual as HTMLElement).classList.add("active-abandonados");
        }
      }
    }

    function verCasoResultado(casoId: string) {
      const caso = historialOriginal.find((c) => c.casoId === casoId);

      if (!caso) {
        abrirModal(
          "info",
          "Caso No Encontrado",
          "No se pudo encontrar la informaci√≥n del caso.",
          null
        );
        return;
      }

      abrirModalResultado(caso);
    }

    // ELIMINAR CASO INDIVIDUAL - CORREGIDO
    function confirmarEliminarCaso(casoId: string, tituloCaso: string) {
      abrirModal(
        "peligro",
        "Eliminar Expediente",
        `¬øEst√°s seguro de que quieres eliminar el caso "${tituloCaso}" permanentemente? Esta acci√≥n no se puede deshacer.`,
        () => eliminarCasoIndividual(casoId)
      );
    }

    function eliminarCasoIndividual(casoId: string) {
      // Encontrar el √≠ndice del caso espec√≠fico (usando el primer caso con ese ID)
      const casoIndex = historialOriginal.findIndex((c) => c.casoId === casoId);

      if (casoIndex !== -1) {
        // Eliminar solo ese caso del array
        historialOriginal.splice(casoIndex, 1);

        // Actualizar localStorage
        localStorage.setItem(
          "historial-casos",
          JSON.stringify(historialOriginal)
        );

        // Recargar la vista
        aplicarFiltro();

        // Mostrar confirmaci√≥n
        setTimeout(() => {
          abrirModal(
            "info",
            "Caso Eliminado",
            "El caso ha sido eliminado exitosamente del archivo.",
            null
          );
        }, 300);
      } else {
        abrirModal(
          "info",
          "Caso No Encontrado",
          "No se pudo encontrar el caso especificado. Puede que ya haya sido eliminado.",
          null
        );
      }
    }

    // Ver detalles del caso
    function verCasoDetalles(casoId: string) {
      const caso = historialOriginal.find((c) => c.casoId === casoId);

      if (!caso) {
        abrirModal(
          "info",
          "Caso No Encontrado",
          "No se pudo encontrar la informaci√≥n del caso.",
          null
        );
        return;
      }

      let detalles = `T√≠tulo: ${caso.titulo || "Sin t√≠tulo"}\n`;
      const estado = caso.estado || (caso.resuelto ? 'resuelto' : 'pendiente');
      const estadoEtiquetaMap = {
        resuelto: '‚úÖ Resuelto',
        pendiente: '‚è≥ Pendiente',
        fallido: '‚ùå Fallido',
        abandonado: 'üìÅ Abandonado'
      } as const;
      const estadoEtiqueta = (estadoEtiquetaMap as any)[estado] || '‚è≥ Pendiente';
      detalles += `Estado: ${estadoEtiqueta}\n`;
      detalles += `ID: ${caso.casoId || "Sin ID"}\n`;

      if (caso.fechaCreacion) {
        const fecha = new Date(caso.fechaCreacion);
        detalles += `Fecha: ${fecha.toLocaleDateString("es-ES")}\n`;
      }

      if (caso.tiempoResolucion) {
        detalles += `Tiempo de resoluci√≥n: ${caso.tiempoResolucion}\n`;
      }

      if (caso.dificultad) {
        detalles += `Dificultad: ${caso.dificultad}\n`;
      }

      if (caso.descripcion) {
        detalles += `\nDescripci√≥n:\n${caso.descripcion}\n`;
      }

      if (caso.culpable) {
        detalles += `\nCulpable: ${caso.culpable}\n`;
      }

      abrirModal("info", "Detalles del Caso", detalles, null);
    }

    // Cargar caso para continuar investigaci√≥n (SOLO casos pendientes)
    function cargarCasoEnJuego(caso: any) {
      try {
        const estado = caso.estado || (caso.resuelto ? 'resuelto' : 'pendiente');
        // Verificar que el caso sea reanudable
        if (estado !== 'pendiente') {
          abrirModal(
            "info",
            "Caso Ya Resuelto",
            "Este expediente ya est√° cerrado y no puede ser reabierto.",
            null
          );
          return;
        }

        const currentStore = JSON.parse(
          localStorage.getItem("yo-no-fui-storage") ||
            '{"state":{},"version":0}'
        );

        const newState = {
          ...currentStore,
          state: {
            ...currentStore.state,
            casoActual: {
              id: caso.casoId,
              titulo: caso.titulo,
              ...caso.data,
              resuelto: false,
            },
            pistasDescubiertas: caso.pistasDescubiertas || [],
            ayudasUsadas: caso.ayudasUsadas || [],
            hipotesisActual: caso.hipotesisActual || null,
            errores: caso.errores || 0,
            tiempoInicio: caso.tiempoInicio || Date.now(),
          },
        };

        localStorage.setItem("yo-no-fui-storage", JSON.stringify(newState));
        window.location.href = "/investigar";
      } catch (e) {
        console.error("Error al cargar el caso:", e);
        abrirModal(
          "info",
          "Error Cr√≠tico",
          "No se pudo cargar el expediente. Int√©ntalo de nuevo.",
          null
        );
      }
    }

    // Exportar historial
    function exportarHistorial() {
      if (historialOriginal.length === 0) {
        abrirModal(
          "info",
          "Archivo Vac√≠o",
          "No hay casos para exportar.",
          null
        );
        return;
      }

      const datos = {
        historial: historialOriginal,
        exportadoEn: new Date().toISOString(),
        totalCasos: historialOriginal.length,
        casosResueltos: historialOriginal.filter((c) => c.resuelto).length,
        version: "Yo no fui - Expediente Criminal v1.0",
        notas: "Archivo de casos generados por IA - Confidencial",
      };

      const dataStr = JSON.stringify(datos, null, 2);
      const dataUri =
        "data:application/json;charset=utf-8," + encodeURIComponent(dataStr);

      const nombreArchivo = `expedientes-criminales-${new Date().toISOString().split("T")[0]}.json`;

      const link = document.createElement("a");
      link.setAttribute("href", dataUri);
      link.setAttribute("download", nombreArchivo);
      link.style.display = "none";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      abrirModal(
        "info",
        "Exportaci√≥n Exitosa",
        `Se han exportado ${historialOriginal.length} casos exitosamente.`,
        null
      );
    }

    // Limpiar historial COMPLETO
    function limpiarHistorial() {
      if (historialOriginal.length === 0) {
        abrirModal(
          "info",
          "Archivo Vac√≠o",
          "No tienes casos archivados para eliminar.",
          null
        );
        return;
      }

      abrirModal(
        "peligro",
        "‚ö†Ô∏è ALERTA: Eliminar TODO el historial",
        `Esta acci√≥n eliminar√° permanentemente los ${historialOriginal.length} casos de tu archivo. Esta acci√≥n NO se puede deshacer. ¬øEst√°s absolutamente seguro?`,
        () => {
          localStorage.removeItem("historial-casos");
          historialOriginal = [];
          aplicarFiltro();

          abrirModal(
            "info",
            "Archivo Limpiado",
            "Todos los casos han sido eliminados del archivo.",
            null
          );
        }
      );
    }

    // Inicializar al cargar la p√°gina
    document.addEventListener("DOMContentLoaded", function () {
      cargarHistorial();

      // Configurar eventos
      const buscarInput = document.getElementById("buscar-casos");
      if (buscarInput) {
        buscarInput.addEventListener("input", () => {
          setTimeout(aplicarFiltro, 300);
        });
      }

      const ordenarSelect = document.getElementById("ordenar-casos");
      if (ordenarSelect) {
        ordenarSelect.addEventListener("change", aplicarFiltro);
      }

      const btnPrev = document.getElementById("pagina-prev");
      if (btnPrev) {
        btnPrev.addEventListener("click", () => setPagina(paginaActual - 1));
      }

      const btnNext = document.getElementById("pagina-next");
      if (btnNext) {
        btnNext.addEventListener("click", () => setPagina(paginaActual + 1));
      }

      // Aplicar filtro inicial (persistido si existe)
      let filtroInicial = "todos";
      try {
        const saved = localStorage.getItem(LS_ARCHIVO_FILTRO);
        if (saved) filtroInicial = saved;
      } catch (_) {
        // ignore
      }
      filtrarCasos(filtroInicial);

      // Efecto de escritura en el t√≠tulo
      const title = document.querySelector("h1");
      if (title) {
        const text = title.textContent;
        title.textContent = "";

        let i = 0;
        const typeWriter = () => {
          if (i < text.length) {
            title.textContent += text.charAt(i);
            i++;
            setTimeout(typeWriter, 50);
          }
        };

        setTimeout(typeWriter, 500);
      }
    });

    // Hacer funciones disponibles globalmente
    (window as any).filtrarCasos = filtrarCasos;
    (window as any).exportarHistorial = exportarHistorial;
    (window as any).limpiarHistorial = limpiarHistorial;
    (window as any).confirmarEliminarCaso = confirmarEliminarCaso;
    (window as any).verCasoDetalles = verCasoDetalles;
    (window as any).verCasoResultado = verCasoResultado;
    (window as any).cerrarModal = cerrarModal;
  </script>
</MainLayout>
